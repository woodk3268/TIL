# ✅ 무결성 제약조건 통합 정리

---

## 📌 학습 주제

* 무결성 제약조건의 전체 구조와 등장 이유
* 개체 무결성 vs 참조 무결성의 차이와 실제 동작 방식
* NULL과 외래키, 기본키의 관계
* 외래키-기본키-대체키 간 상호작용
* 제약조건의 설계 순서와 실무적 판단 기준
* 자기참조 외래키, 외래키가 기본키인 구조, 복합키 활용

---

## 🧩 무결성 제약조건: 정의와 역할

| 제약조건 종류                        | 정의                                         |
| ------------------------------ | ------------------------------------------ |
| 개체 무결성 (Entity Integrity)      | 기본키(PK)는 NULL일 수 없고 중복될 수 없음 – 튜플 유일 식별 보장 |
| 참조 무결성 (Referential Integrity) | 외래키(FK)는 참조 대상 테이블의 기본키 또는 UNIQUE 값이어야 함   |
| 도메인 무결성                        | 속성은 정해진 타입과 범위의 값을 가져야 함 (예: 나이 ≥ 0)       |

---

## 🔎 제약조건이 생긴 이유

| 단계        | 설명                                                       |
| --------- | -------------------------------------------------------- |
| ① 현실 문제   | 중복 데이터, 존재하지 않는 참조, 음수 가격 등 비정상 데이터 발생                   |
| ② 규칙 수립   | 중복 불가, 참조 강제, 형식 제한 등의 룰을 도입                             |
| ③ DBMS 적용 | SQL 제약조건으로 자동 검사 (`PRIMARY KEY`, `FOREIGN KEY`, `CHECK`) |
| ④ 개념 명명   | 이를 ‘무결성 제약조건’이라는 이름으로 학문화 (관계형 모델 기반)                    |

---

## ✅ 개체 무결성 제약조건

| 특징   | 설명                             |
| ---- | ------------------------------ |
| 대상   | **기본키(PK)**                    |
| 규칙   | NULL 불가 + 중복 불가                |
| 목적   | 튜플 유일 식별                       |
| 위반 예 | NULL 또는 중복된 기본키 입력             |
| 예시   | 주민번호 없이 주민 등록 / 같은 학번이 두 번 등록됨 |

```sql
CREATE TABLE users (
  user_id INT PRIMARY KEY, -- NOT NULL + UNIQUE
  name VARCHAR(50)
);
```

---

## ✅ 참조 무결성 제약조건

| 특징   | 설명                                        |
| ---- | ----------------------------------------- |
| 대상   | **외래키(FK)**                               |
| 규칙   | 참조 대상의 PK 또는 UNIQUE 값 존재 필수<br>또는 NULL 가능 |
| 목적   | 릴레이션 간 관계의 논리 일관성 유지                      |
| 위반 예 | 존재하지 않는 고객 ID로 주문 생성                      |
| 예시   | 주문 테이블에서 없는 고객을 참조 (`user_id = 'ghost'`)  |

```sql
CREATE TABLE orders (
  order_id INT PRIMARY KEY,
  user_id INT,
  FOREIGN KEY (user_id) REFERENCES users(user_id)
);
```

---

## ✅ 외래키 + 기본키 / 대체키 응용

| 구조        | 설명               | 실무 사례                     |
| --------- | ---------------- | ------------------------- |
| 외래키 = 기본키 | 외래키가 기본키 역할도 수행  | 1:1 관계 (users - profiles) |
| 외래키 = 대체키 | FK가 UNIQUE 속성 참조 | 이메일 등 의미 있는 식별자 참조        |
| 자기참조 외래키  | 자기 테이블의 PK 참조    | 조직도, 카테고리 트리 구조 등         |

```sql
-- 자기참조 예시
CREATE TABLE departments (
  dept_id INT PRIMARY KEY,
  name VARCHAR(50),
  parent_id INT,
  FOREIGN KEY (parent_id) REFERENCES departments(dept_id)
);
```

---

## ⚠️ NULL과 무결성의 관계

| 상황            | 무결성 위반 여부 | 설명                      |
| ------------- | --------- | ----------------------- |
| 기본키에 NULL     | ✅ 위반      | 식별 불가                   |
| 외래키에 NULL     | ❌ 위반 아님   | 부모가 없음을 의미하는 “미정 상태” 허용 |
| 외래키 값 존재하지 않음 | ✅ 위반      | 참조할 부모가 없으면 논리 불일치      |

---

## 📌 복합키와 무결성

| 키 유형    | 설명                                  |
| ------- | ----------------------------------- |
| 복합 기본키  | 2개 이상의 속성으로 유일 식별                   |
| 복합 외래키  | 두 속성 모두 참조해야 함                      |
| 제약조건 적용 | 각 속성 도메인 일치 + 둘 다 PK/UNIQUE여야 참조 가능 |

```sql
FOREIGN KEY (order_id, item_id) REFERENCES order_items(order_id, item_id)
```

---

## 🛠️ 실무 적용 전략

| 전략 항목         | 설명                                                    |
| ------------- | ----------------------------------------------------- |
| 무결성 제약 최소한 유지 | 가능한 범위 내에서 DB 차원에서 검사하도록 설정                           |
| 삭제/수정 정책 명확화  | ON DELETE / ON UPDATE 옵션 활용 (`CASCADE`, `SET NULL` 등) |
| 대체키 활용        | 사용자 입력값 (이메일 등)에는 UNIQUE 제약만, PK는 surrogate key 사용    |
| 인덱스 튜닝        | 외래키에도 인덱스 추가해 JOIN 최적화                                |

---

## 💬 대표 질문과 정리

**Q. 무결성 제약조건이 없다면 어떤 문제가 생길까?**
→ 데이터가 논리적으로 거짓이 되며, 시스템 전체 신뢰성 붕괴

**Q. 외래키가 NULL일 수 있는 이유는?**
→ 부모가 아직 존재하지 않거나, 참조가 의도적으로 없을 수도 있기 때문 (게스트 계정 등)

**Q. 개체 무결성과 참조 무결성은 언제 동시에 위반될 수 있을까?**
→ FK에 NULL을 넣고, 동시에 참조 대상 PK를 삭제했을 때 정합성 붕괴 가능성 있음

---

## 🧠 인사이트

* 무결성 제약조건은 **데이터를 현실 세계의 규칙에 맞게 통제**하는 메커니즘이다.
* 시스템 설계 초기 단계에서 반드시 **비즈니스 로직을 기준으로 제약조건을 설정**해야 하며,
* 제약을 생략하거나 코드로만 관리하려 할 경우, **데이터 품질은 장기적으로 무너진다.**

