# ✅ MySQL 스레드 풀 & 메타데이터 구조 TIL

---

## 📌 학습 주제

* MySQL 스레드 풀의 동작 원리 및 코어 수 기준 스레드 그룹 설계
* Query Cache의 목적과 실패 원인
* 옵티마이저와 핸들러의 역할 분리
* InnoDB 메타데이터 저장 방식 (`.frm` → 시스템 테이블)
* MySQL 8.0 데이터 딕셔너리 및 SDI 구조

---

## 🧩 핵심 개념 요약

| 개념                               | 설명                                                        |
| -------------------------------- | --------------------------------------------------------- |
| 스레드 풀                            | 스레드를 미리 만들어놓고 작업을 분배하는 구조. 스레드 생성 비용 절감, 자원 효율성 향상        |
| 스레드 그룹                           | 작업 큐 + 워커 스레드 집합. **CPU 코어 수**만큼 만드는 게 이상적                |
| Processor Affinity               | 스레드 그룹을 특정 코어에 고정시켜 캐시 효율 및 컨텍스트 스위치 최소화                  |
| 선순위/후순위 큐                        | 빠르게 끝나는 작업(조회 등)은 선순위 큐, 무거운 작업은 후순위 큐로 분리                |
| Query Cache                      | 동일 쿼리 결과 재사용을 위한 캐시. 낮은 히트율, 전역 락, 무효화 문제로 MySQL 8.0에서 제거 |
| 옵티마이저                            | 실행 계획 수립 담당 (인덱스 사용 여부, 조인 순서 등 결정)                       |
| 실행엔진 & 핸들러                       | 실행엔진이 실행 계획을 수행하고, 핸들러는 실제 데이터 읽기/쓰기 처리                   |
| `.frm` 파일                        | MySQL 5.x까지 테이블 구조 저장에 사용된 바이너리 파일 (비공식 포맷)               |
| InnoDB 시스템 테이블                   | MySQL 8.0부터 테이블 구조, 권한, 트리거 등을 내부 시스템 테이블에 저장             |
| mysql.ibd                        | InnoDB 시스템 테이블이 저장된 파일 (딕셔너리 정보 포함)                       |
| SDI (Serialized Dictionary Info) | 테이블 구조를 `.ibd` 내부에 JSON 형태로 직렬화해 저장하는 정보                  |

---

## 🔁 동작 구조 요약

### ✅ 스레드 풀

```
[사용자 요청] 
   ↓ 
[스레드 그룹 (코어 수 기준)] 
   ↓ 
[선순위 / 후순위 큐] 
   ↓ 
[워커 스레드 처리]
```

### ✅ InnoDB 메타데이터 저장 흐름

```
[CREATE TABLE ...] 
   ↓ 
[InnoDB 시스템 테이블에 구조 저장] 
   ↓ 
[mysql.ibd 파일 내부에 저장됨] 
   ↓ 
[ibd2sdi 도구로 JSON 추출 가능]
```

---

## ⚠️ 과거 방식의 문제점 (MySQL 5.x)

| 문제                 | 설명                              |
| ------------------ | ------------------------------- |
| `.frm` 손상 시 복구 어려움 | 구조와 데이터가 분리되어 있어 동기화 실패 시 복구 불가 |
| 트랜잭션 미지원           | 구조 변경 중 서버 종료 시 메타데이터 손상 위험     |
| Query Cache 오히려 병목 | 낮은 캐시 히트율 + 전역 락으로 오히려 느려짐      |

---

## ✅ MySQL 8.0의 개선점

* 모든 메타데이터를 InnoDB에 트랜잭션으로 저장 → **일관성, 복구력, 안정성 향상**
* `mysql.tables`, `mysql.columns` 등 시스템 딕셔너리 테이블로 통합
* 메타데이터 SELECT 제한 → `ibd2sdi` 도구로 JSON 형태로 추출 가능
* `.frm` 완전 제거 + SDI 포맷 도입

---

## 💡 인사이트

* **스레드 풀은 단순 성능 향상이 아닌 자원 효율 관리 전략**
* 메타데이터도 결국 "데이터"로서 트랜잭션 안전성이 중요함
* 구조/데이터를 분리하지 않고 통합 관리해야 DB 복구가 가능함
* MySQL 8.0은 스토리지 엔진 수준에서 메타데이터 신뢰성을 강화함


